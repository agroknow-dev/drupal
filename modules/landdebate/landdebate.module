<?php
/**
 * @file
 * This module provide an interface to the landdebate section of the Landportal.
 *
 * The Landportal landdebate
 *
 * Original work by: WESO
 * Drupal refactoring: Jules <jules@ker.bz>
 */

$GLOBALS['landdebate_menu'] = 'landdebate-menu';
$GLOBALS['landdebate_default_ct'] = 'news';

ctools_include('landdebate.view_default', 'landdebate');
ctools_include('landdebate.menu', 'landdebate');

function landdebate_help($path, $arg) {
  switch ($path) {
  case "admin/help#landdebate":
    return '<p>' . t("Landdebate section of the Landportal") . '</p>'
      . '<p>'. t("This come with a (header) Block, customised View(s) and a landdebate main-menu item").'</p>'
      . '<p>'. t("Landdebate sections are:").'</p>'
      ;
    break;
  }
}


function landdebate_menu() {
  $items = array();
  landdebate_admin_menu($items);

  // Landdebate frontend
  $items['debate'] = array(
    'title'		=> 'Landdebate',
    'menu_name'		=> 'main-menu',
    'access callback'	=> TRUE,
    'weight'            => 1,
    'page callback'	=> 'views_page',
    'page arguments'	=> array('debate', $GLOBALS['landdebate_default_ct']),
  );
  $translatables['debate'][] = t($items['debate']['title']);

  $landebate_ct = array('news', 'debate', 'event', 'blog_post', 'organization');
  foreach ($landebate_ct as $s) {
    $items['debate/' . $s] = array(
      'title'           => ucfirst(str_replace('_', ' ', $s)),
      'menu_name'       => $GLOBALS['landdebate_menu'],
      'access callback'	=> TRUE,
      'page callback'   => 'landdebate_vcb',
      'page arguments'  => array(1),
    );
    $translatables['debate'][] = t($items['debate/' . $s]['title']);
  }
  return $items;
}

function landdebate_views_api() {
  return array('api' => 3.0);
}

/**
 * Blocks configuration for landdebate
 * Force landdebate-menu to appear in the highlighted section
 *
 * TODO: bugfix: pages & visibility config doesn't appear in the block configuration page (it seems to work ok though)
 */
function landdebate_block_info_alter(&$blocks, $theme, $code_blocks) {
  if ($theme == 'landportal') {
    $blocks['menu'][$GLOBALS['landdebate_menu']]['status'] = TRUE;
    $blocks['menu'][$GLOBALS['landdebate_menu']]['region'] = 'highlighted';
    $blocks['menu'][$GLOBALS['landdebate_menu']]['visibility'] = BLOCK_VISIBILITY_LISTED;
    $blocks['menu'][$GLOBALS['landdebate_menu']]['pages'] = "debate\ndebate/*";
  }
  return $blocks;
}



/* function landdebate_node_view($node, $view_mode, $lang) { */
/*   if ($node->type == 'news') { */
/*         $breadcrumb = array(); */
/*         $breadcrumb[] = l(t('Home'), '<front>'); */
/*         $breadcrumb[] = l(t('landdebate'), 'debate'); */
/*         $breadcrumb[] = l(t('News'), 'debate/news'); */
/*         drupal_set_breadcrumb($breadcrumb); */
/*   } */
/* } */


/* function landdebate_menu_breadcrumb_alter(&$active_trail, $item){ */
/*   menu_set_active_item('debate'); */
/*   /\* dpm($item); *\/ */
/*   //$active_trail[] = $item; */
/*   // array('title' => t($item['title']), 'href'  => $item['path']); *\/ */
/*   dpm($active_trail); */

/*   $b = array(); */
/*   foreach ($active_trail as $i=>$a) { */
/*     $a['weight'] = $i; */
/*     $b[$i] = $a; */
/*   } */
/*   $item['weight'] = ++$i; */
/*   $b[$i] = $item; */
  
/*   $active_trail = drupal_set_breadcrumb($b);//active_trail); */
/*   dpm($active_trail); */
/* } */



