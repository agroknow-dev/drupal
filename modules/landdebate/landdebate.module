<?php
/**
 * @file
 * This module provide an interface to the landdebate section of the Landportal.
 *
 * The Landportal landdebate
 *
 * Original work by: WESO
 * Drupal refactoring: Jules <jules@ker.bz>
 */

$GLOBALS['landdebate_menu'] = 'landdebate-menu';
$GLOBALS['landdebate_content_types'] = array('news', 'debate', 'event', 'blog_post', 'organization');
$GLOBALS['landdebate_default_ct'] = 'news';

ctools_include('landdebate.view_default',       'landdebate');
ctools_include('landdebate.menu',               'landdebate');
ctools_include('landdebate.context',            'landdebate');

function landdebate_help($path, $arg) {
  switch ($path) {
  case "admin/help#landdebate":
    return '<p>' . t("Landdebate section of the Landportal") . '</p>'
      . '<p>'. t("This come with a (header) Block, customised View(s) and a landdebate main-menu item").'</p>'
      . '<p>'. t("Landdebate sections are:").'</p>'
      ;
    break;
  }
}

function landdebate_menu() {
  $items = array();
  landdebate_menu_admin($items);
  landdebate_menu_build($items);

  // Landdebate frontend
  $items['debate'] = array(
    'title'		=> 'Landdebate',
    'menu_name'		=> 'main-menu',
    'access callback'	=> TRUE,
    'weight'            => 1,
    'page callback'	=> 'views_page',
    'page arguments'	=> array('debate', $GLOBALS['landdebate_default_ct']),
  );
  $translatables['debate'][] = t($items['debate']['title']);
  return $items;
}

function landdebate_views_api() {
  return array('api' => 3.0);
}

function landdebate_ctools_plugin_api($module = NULL, $api = NULL) {
  if ($module == "context" && $api == "context") {
    return array("version" => "3");
  }
}

/**
 * Blocks configuration for landdebate section header
 *
 * TODO: bugfix: pages & visibility config doesn't appear in the block configuration page (it seems to work ok though)
 */
function landdebate_block_info_alter(&$blocks, $theme, $code_blocks) {
  if ($theme == 'landportal') {
    $blocks['menu'][$GLOBALS['landdebate_menu']]['status'] = TRUE;
    $blocks['menu'][$GLOBALS['landdebate_menu']]['region'] = 'section_header';
    $blocks['menu'][$GLOBALS['landdebate_menu']]['visibility'] = BLOCK_VISIBILITY_LISTED;
    $blocks['menu'][$GLOBALS['landdebate_menu']]['pages'] = "debate\ndebate/*";
  }
  return $blocks;
}


/* function landdebate_page_alter(&$page) { */
/*   $block = module_invoke('menu', 'block_view', 'landdebate-menu'); */
/*   dpm($block); */
/*   //$menu = menu_load($GLOBALS['landdebate_menu']); */
/*   /\* $tree = menu_tree($GLOBALS['landdebate_menu']); *\/ */
/*   /\* dpm($tree); *\/ */
/* } */

/* function landdebate_process(&$variables, $hook) { */
/*   if ($hook == 'page') { */
/*     dpm($variables['page']['section_header']); */
/*     //dpm($variables['attributes_array']); */
    
/*   } */
/* } */

/* function landdebate_node_view($node, $view_mode, $lang) { */
/*   if ($node->type == 'news') { */
/*     dpm($node); */
/*     $menu = menu_load($GLOBALS['landdebate_menu']); */
/*     dpm($menu); */
/*     $node->section_header['menu_landdebate-menu'] = $menu; */
/*         /\* $breadcrumb = array(); *\/ */
/*         /\* $breadcrumb[] = l(t('Home'), '<front>'); *\/ */
/*         /\* $breadcrumb[] = l(t('landdebate'), 'debate'); *\/ */
/*         /\* $breadcrumb[] = l(t('News'), 'debate/news'); *\/ */
/*         /\* drupal_set_breadcrumb($breadcrumb); *\/ */
/*   } */
/* } */

/* function landdebate_menu_breadcrumb_alter(&$active_trail, $item){ */
/*   menu_set_active_item('debate'); */
/*   /\* dpm($item); *\/ */
/*   //$active_trail[] = $item; */
/*   // array('title' => t($item['title']), 'href'  => $item['path']); *\/ */
/*   dpm($active_trail); */
/*   $b = array(); */
/*   foreach ($active_trail as $i=>$a) { */
/*     $a['weight'] = $i; */
/*     $b[$i] = $a; */
/*   } */
/*   $item['weight'] = ++$i; */
/*   $b[$i] = $item; */  
/*   $active_trail = drupal_set_breadcrumb($b);//active_trail); */
/*   dpm($active_trail); */
/* } */



