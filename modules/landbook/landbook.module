<?php
/**
 * @file
 * This module provide an interface to the landbook section of the Landportal.
 *
 * The Landportal landbook
 *
 * Original work by: WESO (http://www.weso.es/)
 * Drupal refactoring: Jules <jules@ker.bz>
 */

require_once(drupal_get_path('module', 'landbook').'/utils/database_helper.php');
require_once(drupal_get_path('module', 'landbook').'/utils/cache_helper.php');

$GLOBALS['landbook_menu'] = 'landbook-menu';
$GLOBALS['landbook_sections'] = array('regions', 'countries', 'catalog', 'indicators', 'sources', 'reuse', 'widgets');
ctools_include('landbook.menu', 'landbook');

function landbook_help($path, $arg) {
  switch ($path) {
  case "admin/help#landbook":
    return '<p>' . t("Landbook section of the Landportal") . '</p>'
      . '<p>' . t("This come with a (header) Block, customised View(s) and a landbook main-menu item") .'</p>'
      . '<p>' . t("The Landbook is composed of different modules: catalog, countries, indicators, regions, reuse, sources, widgets") . '</p>'
      . '<p>' . t("Each comes with a set of template and JS to allow dynamic actions.") . '</p>'
      ;
    break;
  }
}

function landbook_theme($existing, $type, $theme, $path) {
  $struct = array(
    'variables' => array(
      'title' => 'landbook page',
      'data' => NULL,
    ),
    'path' => drupal_get_path('module', 'landbook') . '/theme',
  );
  return array(
    'regions'           => $struct + array('template' => 'regions'),
    'catalog'           => $struct + array('template' => 'catalog'),
    'countries'         => $struct + array('template' => 'countries'),
    'country'           => $struct + array('template' => 'country'),
    'datasource'        => $struct + array('template' => 'datasource'),
    'datasources'       => $struct + array('template' => 'datasources'),
    'indicator'         => $struct + array('template' => 'indicator'),
    'indicators'        => $struct + array('template' => 'indicators'),
    'reuse'             => $struct + array('template' => 'reuse'),
    'widgets'           => $struct + array('template' => 'widgets'),
  );
}


/**
 * Register JS variables through Drupal system.
 * They are (only?) used by landbook/js/controller/*js files
 */
function landbook_add_js_vars($args=NULL) {
  global $language;
  // TODO: should come from a module variable (manageable via in admin/settings)
  $path = '/' . drupal_get_path('module', 'landbook');
  $url = '/' . drupal_get_path('theme', 'landportal');

  // Use those variables in javascript with:
  //  var XXX = Drupal.settings.landbook.XXX
  drupal_add_js(array('landbook' => array(
    'languageCode'    => $language->language,
    'imagesURL'       => $url . '/images',              // landportal theme related
    'ajaxURL'         => $path . '/ajax',               // landbook module related

    // only for countries hook
    'countryCode'     => $args,

    // Should be configurable through admin/settings/landbook/ , default values in local.settings.php
    'apiURL'          => $GLOBALS['landbook_urls']['api'],
    'ckanURL'         => $GLOBALS['landbook_urls']['ckan'],
    'sparqlURL'       => $GLOBALS['landbook_urls']['sparql'],
  )), 'setting'
  );
}

/**
 * Includes specific Landbook Javascripts and CSS
 * This is directly included by the 'page callback' functions (in landbook/modules/*inc)
 * Not all pages require this to work.
 */
function landbook_add_js_css() {
  // TODO: work out (fix weso scripts?) jquery stuff Drupal way.
  /* drupal_add_js('misc/jquery.js'); */
  /* drupal_add_js('misc/jquery.once.js'); */
  //drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/jquery-2.1.0.min.js');

  // Global stuff for the portal, should live in theme (?)
  //drupal_add_js(drupal_get_path('module', 'landbook').'/js/search.js');
  //drupal_add_js(drupal_get_path('module', 'landbook').'/js/ajax.js');
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/bootstrap.min.js');
  // Some helpers to generate HTML and stuff
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/util.js');
  // Weird shit from WESO students re-inventing the wheel
  //drupal_add_js(drupal_get_path('module', 'landbook').'/js/language.js');

  // Below this, it should be OK (clean)
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/canvg.js');
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/rgbcolor.js');
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/StackBlur.js');
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/seedrandom.min.js');
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/country_chart_options.js');
  drupal_add_js(drupal_get_path('module', 'landbook').'/js/libraries/wesCountry.min.js');

  // TODO: use separate function to do CSS includes: hook_preprocess_html (?)
  // bootstrap is (should be?) included form theme/landbook (?)
  drupal_add_css(drupal_get_path('theme', 'landportal').'/css/bootstrap.min.css');
  drupal_add_css(drupal_get_path('theme', 'landportal').'/css/font-awesome.min.css');
  drupal_add_css(drupal_get_path('module', 'landbook').'/js/libraries/wesCountry.min.css');
}

function landbook_menu() {
  $items = array();
  landbook_menu_admin($items);
  // Automatically build Landbook menu according to available modules
  landbook_menu_build($items);

  // Landbook main-menu link
  $items['book'] = array(
    'title'		=> 'Landbook',
    'menu_name'		=> 'main-menu',
    'type'              => MENU_NORMAL_ITEM,
    'access callback'	=> TRUE,
    'page callback'	=> 'landbook_regions',
    'page arguments'	=> array(),
    'file'              => 'regions.inc',
    'file path'         => drupal_get_path('module', 'landbook').'/modules'
  );
  $translatables['book'][] = t('Landbook');
  return $items;
}

/**
 * Force landbook-menu block to display on landportal theme
 */
function landbook_block_info_alter(&$blocks, $theme, $code_blocks) {
  if ($theme == 'landportal') {
    $blocks['menu'][$GLOBALS['landbook_menu']]['status'] = TRUE;
    $blocks['menu'][$GLOBALS['landbook_menu']]['region'] = 'section_header';
    $blocks['menu'][$GLOBALS['landbook_menu']]['visibility'] = BLOCK_VISIBILITY_LISTED;
    $blocks['menu'][$GLOBALS['landbook_menu']]['pages'] = "book\nbook/*";
  }
  return $blocks;
}

/* function landbook_theme_registry_alter(&$theme_registry) { */
/*   $path = drupal_get_path('module', 'landbook'); */
/*   $templates = drupal_find_theme_templates($theme_registry, '.tpl.php', $path.'/theme'); */
/*   drupal_set_message('in '.$path.'/theme'); */
/*   dpm($templates); */
/*     // Itterate through all found template file objects. */
/*     foreach ($templates as $key => $t) { */
/*         // If the template has not already been overridden by a theme. */
/*         if (!isset($theme_registry[$key]['theme path']) || !preg_match('#/themes/#', $theme_registry[$key]['theme path'])) { */
/*             // Alter the theme path and template elements. */
/*             $theme_registry[$key]['theme path'] = $path; */
/*             $theme_registry[$key] = array_merge($theme_registry[$key], $t); */
/*             $theme_registry[$key]['type'] = 'module'; */
/*         } */
/*     } */
/* } */
